{"id":"editable_reblogs","script":"//* TITLE Editable Reblogs **//\n//* VERSION 2.1.3 **//\n//* DESCRIPTION\tRestores ability to edit previous reblogs of a post **//\n//* DEVELOPER new-xkit **//\n//* FRAME false **//\n//* BETA false **//\n\nXKit.extensions.editable_reblogs = new Object({\n\n\trunning: false,\n\n\trun: function() {\n\t\tthis.running = true;\n\n\t\tXKit.interface.post_window_listener.add(\"editable_reblogs\", XKit.extensions.editable_reblogs.post_window);\n\t\tXKit.tools.add_css(\".control-reblog-tree {display: none; } .post-form--header .reblog-title {margin: 10px; color: #444} \", \"editable_reblogs_remove_content_tree\");\n\n\t\tvar pat_ver = XKit.tools.parse_version(XKit.installed.get(\"xkit_patches\").version);\n\t\tif (pat_ver.major <=5 && pat_ver.minor <= 3 && pat_ver.patch <= 0){\n\t\t\tXKit.extensions.xkit_updates.update('xkit_patches', function(result){\n\t\t\t\tif(result.errors){\n\t\t\t\t\tXKit.window.show('Updating error', 'ERROR: Editable Reblogs does not support your version of XKit Patches, '+\n\t\t\t\t\t'and cannot automatically update it.<br><br>'+\n\t\t\t\t\t\"Try force updating all extensions from the gallery, and if that fails, try uninstalling and reinstalling XKit.\",\n\t\t\t\t\t'error', \"<div id=\\\"xkit-close-message\\\" class=\\\"xkit-button\\\">OK</div>\");\n\t\t\t\t} else {\n\t\t\t\t\twindow.location = window.location;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\tpost_window: function() {\n\t\tvar is_legacy = $(\".reblog-tree\").length > 0;\n\t\tif (is_legacy) {\n\t\t\tXKit.extensions.editable_reblogs.post_window_legacy();\n\t\t\treturn;\n\t\t}\n\t\tvar reblog_tree = $(\".post-form .reblog-list\");\n\n\t\tvar all_quotes = [];\n\t\tvar old_content = '';\n\t\tvar all_quotes_text = '';\n\t\t// Guard against double evaluation by marking the tree as processed\n\t\tvar processed_class = 'xkit-editable-reblogs-done';\n\t\tif (reblog_tree.length > 0) {\n\t\t\tif (reblog_tree.hasClass(processed_class)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\treblog_tree.addClass(processed_class);\n\n\t\t\tvar title = reblog_tree.find('.reblog-title');\n\t\t\t$('.post-form--header').append(title);\n\t\t\treblog_tree.find(\".reblog-list-item\").each(function(index) {\n\t\t\t\tvar reblog_data = {\n\t\t\t\t\treblog_content: $(this).find('.reblog-content').html() ? $(this).find('.reblog-content').html() : '',\n\t\t\t\t\treblog_author: $(this).find('.reblog-tumblelog-name').text() ? $(this).find('.reblog-tumblelog-name').text() : '',\n\t\t\t\t\treblog_url: $(this).find('.reblog-tumblelog-name').attr('href') ? $(this).find('.reblog-tumblelog-name').attr('href') : ''\n\t\t\t\t};\n\t\t\t\tall_quotes.push(reblog_data);\n\t\t\t});\n\t\t\tall_quotes.forEach(function(data, index, all) {\n\t\t\t\tvar reblog_content = data.reblog_content.replace(\"tmblr-truncated read_more_container\", \"\");\n\t\t\t\t//don't wrap if the previous user didn't add a comment\n\t\t\t\tif (reblog_content.indexOf(\"</blockquote>\", reblog_content.length - 13) !== -1 || reblog_content.length === 0) {\n\t\t\t\t\tall_quotes_text = reblog_content;\n\t\t\t\t} else {\n\t\t\t\t\tall_quotes_text = \"<p><a class='tumblr_blog' href='\" + data.reblog_url + \"'>\" + data.reblog_author + \"</a>:</p><blockquote>\" + all_quotes_text + reblog_content + \"</blockquote>\";\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\ttry {\n\t\t\told_content = XKit.interface.post_window.get_content_html();\n\t\t} catch (e) {\n\t\t\tXKit.window.show('Invalid editor type', 'ERROR: Editable Reblogs cannot currently get content from your default editor type. '+\n\t\t\t\t'To continue using editable reblogs, click <a target=\"_blank\" href=\"https://www.tumblr.com/settings/dashboard\">here</a> '+\n\t\t\t\t'to edit your dashboard settings to use the rich text editor or HTML editor',\n\t\t\t\t'error', \"<div id=\\\"xkit-close-message\\\" class=\\\"xkit-button\\\">OK</div>\");\n\t\t\treturn;\n\t\t}\n\t\t// add 'tumblr_blog' class to all tumblr.com links,\n\t\t// assuming that they're part of a reblog-structure that's not being parsed properly\n\t\tvar nodes = $(all_quotes_text + old_content);\n\t\tnodes.find('a[href*=\"tumblr.com\"]').addClass('tumblr_blog');\n\t\tvar nodes_text = $('<div>').append($(nodes).clone()).html();\n\t\tXKit.interface.post_window.set_content_html(nodes_text);\n\t\t//run submission cleanup before post is submitted\n\t\t$('.controls-container').on('click', '.create_post_button', XKit.extensions.editable_reblogs.process_submit);\n\n\t\t$(\".btn-remove-trail .icon\").click();\n\t\t$(\".control-reblog-trail\").hide();\n\t},\n\tprocess_submit: function(e) {\n\t\te.preventDefault();\n\t\t// use the HTML editor, even if we're on rich-text\n\t\t// (adding content to the rich text editor changes 'tumblr_blog' back to \"tumblr_blog\")\n\t\tif ($(\".html-field\").css(\"display\") === \"none\") {\n\t\t\t// tumblr_blog must be wrapped in single quotes, not double, or the dash will nom the shit out of your post\n\t\t\tvar text = XKit.interface.post_window.get_content_html();\n\t\t\t//********* DO ANY DOM MANIPULATION FIRST *************\n\t\t\t//******if done later it will undo the single quote fix*********\n\t\t\tvar nodes = $('<div>').append($(text));\n\t\t\tnodes.find('.tmblr-truncated').replaceWith('[[MORE]]');\n\t\t\ttext = nodes.html();\n\t\t\t//********ALL DOM MANIPULATION ABOVE THIS LINE*********\n\t\t\ttext = text.replace(/\"tumblr_blog\"/g, \"'tumblr_blog'\");\n\t\t\t// also remove empty HTML if the user hasn't added anything\n\t\t\tif (text.indexOf(\"<p><br></p>\", text.length - 11) !== -1) {\n\t\t\t\ttext = text.substring(0, text.length - 11);\n\t\t\t}\n\t\t\tXKit.tools.add_function(function(){\n\t\t\t\tvar new_content = add_tag[0];\n\t\t\t\tvar editor_div = document.getElementsByClassName(\"ace_editor\");\n\t\t\t\tif (editor_div.length === 1) {\n\t\t\t\t\tvar editor = window.ace.edit(editor_div[0]);\n\t\t\t\t\teditor.setValue(new_content);\n\t\t\t\t\tsetTimeout(function(){\n\t\t\t\t\t\tjQuery(\".ace_marker-layer\").empty();\n\t\t\t\t\t}, 500);\n\t\t\t\t}\n\t\t\t}, true, [text]);\n\t\t} else {\n\t\t\tXKit.tools.add_function(function(){\n\t\t\t\tvar editor_div = document.getElementsByClassName(\"ace_editor\");\n\t\t\t\tif (editor_div.length === 1) {\n\t\t\t\t\tvar editor = window.ace.edit(editor_div[0]);\n\t\t\t\t\tvar content = editor.getValue();\n\t\t\t\t\t// tumblr_blog must be wrapped in single quotes, not double, or the dash will nom the shit out of your post\n\t\t\t\t\tcontent = content.replace(/\"tumblr_blog\"/g, \"'tumblr_blog'\");\n\t\t\t\t\teditor.setValue(content);\n\t\t\t\t\tsetTimeout(function(){\n\t\t\t\t\t\tjQuery(\".ace_marker-layer\").empty();\n\t\t\t\t\t}, 500);\n\t\t\t\t}\n\t\t\t}, true, []);\n\t\t}\n\t},\n\tpost_window_legacy: function() {\n\t\tvar reblog_tree = $(\".reblog-tree\");\n\t\tif (reblog_tree.length <= 0) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Guard against double evaluation by marking the tree as processed\n\t\tvar processed_class = 'xkit-editable-reblogs-done';\n\t\tif (reblog_tree.hasClass(processed_class)) {\n\t\t\treturn;\n\t\t}\n\t\treblog_tree.addClass(processed_class);\n\n\t\t// Convert all of the user links to have class tumblr_blog\n\t\tvar top_quote_link = reblog_tree.find('p:first-child > a:first-child');\n\t\tvar quote_links = reblog_tree.find('blockquote > p:first-child > a:first-child');\n\n\t\tif (top_quote_link.length > 0) {\n\t\t\t$(top_quote_link[0]).addClass('tumblr_blog');\n\t\t}\n\t\tquote_links.each(function() {\n\t\t\t$(this).addClass('tumblr_blog');\n\t\t});\n\n\t\tvar reblog_content = reblog_tree.html();\n\n\t\tvar old_content = XKit.interface.post_window.get_content_html();\n\t\tXKit.interface.post_window.set_content_html(reblog_content + old_content);\n\n\t\t$(\".btn-remove-tree\").click();\n\t},\n\tdestroy: function() {\n\t\tthis.running = false;\n\t\tXKit.tools.remove_css(\"editable_reblogs_remove_content_tree\");\n\t\tXKit.interface.post_window_listener.remove(\"editable_reblogs\");\n\t}\n});\n","icon":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAA4VBMVEUAAAAAAQEBAgICBAQCBQYDBggEBwkHDRAHDhIIEBQIEBUJEhYKFhALFRoLFRsMGRUNGSAPIRgQHycYLzsYNScbNkMcNkQcN0UdOEYdOEceOkgfPUwfPU0gPk0gPk4gP08hQFAiQlMjTTgjTTkkTjktV20tWG4yYXoyYns4bIg7co9Bfp9Bj2lEhKZFhqdFh6lFh6pHiq1JjrJJj7NMlLpNlbtNlrtNlrxNl7pNl7tNmLpOmLlQpKpQpalRpqZRpqdRp6VSqaNSsoNTr5tTsJpTsZhTsZlUspdUsphWu4lWvIqrAtY3AAABFklEQVR42qXQa1OCQBiG4cdKOtn5bEmaZklaZi5v27kgi/3/PygY9l1g02Gm7m/wXMPsAippCpBlYCJLgGIxE6hPWQTfyooFA/W7txIQ+DZ4pCzeC4DyIJRkg/c80Ltodg14sf/ka7yfotLV4Inonmi0Pw9ua0DjPaBynoJ4/yI6gGn3Q7R6iWhoICeKqIqhuUbkLjmxaIgU+KGKAaD3BxV1Vr2Vhd5YpGfwA5UEKF3UrnnrQIuv+awYmL0f78n3p34hOqv1N3jXZwjyZ3AXvTXAFdcZIBlm4AZzy8l+u8kgFQZcAMlO22CQCgOOATQFPxpA5s3OyeWQaAbg/giqGOT2Kzg2qKNY3QajQwdZztEdg5L+D34AmZvHFbsM2NwAAAAASUVORK5CYII=\n","title":"Editable Reblogs","description":"Restores ability to edit previous reblogs of a post","developer":"new-xkit","version":"2.1.3","frame":"false","beta":"false","file":"found","server":"up","errors":false,"slow":"false"}