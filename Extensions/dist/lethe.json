{"id":"lethe","script":"//* TITLE Lethe **//\n//* VERSION 1.0 REV A **//\n//* DESCRIPTION Forgets posts once they scroll off the screen. **//\n//* DEVELOPER hobinjk **//\n//* FRAME false **//\n//* BETA false **//\n\n\n/** Export Lethe */\nXKit.extensions.lethe = new Lethe();\n\nfunction Lethe() {\n  this.TOP_CUTOFF = -3000;\n  this.running = false;\n  this.scrollWaiting = false;\n  this.preferences = {};\n  //   'sep0': {\n  //     text: 'Options',\n  //     type: 'separator'\n  //   },\n  // };\n  //\n  this.handleScroll = this.handleScroll.bind(this);\n}\n\n/**\n * Run Lethe\n */\nLethe.prototype.run = function() {\n  this.running = true;\n  window.addEventListener('scroll', this.handleScroll, false);\n};\n\n/**\n * Handle a scroll event, throttling to once every 100ms\n */\nLethe.prototype.handleScroll = function() {\n  if (this.scrollWaiting) {\n    return;\n  }\n  this.scrollWaiting = true;\n  setTimeout(this.updatePosts.bind(this), 100);\n};\n\n/**\n * Update the list of tracked posts, removing ones that are above/outside the\n * viewport and adding ones that are inside or below the viewport.\n */\nLethe.prototype.updatePosts = function() {\n  this.scrollWaiting = false;\n\n  var postMedias = document.querySelectorAll('.post_media');\n  var i;\n  for (i = 0; i < postMedias.length; i++) {\n    var postMedia = postMedias[i];\n    var rect = postMedia.getBoundingClientRect();\n\n    if (rect.top + rect.height > this.TOP_CUTOFF) {\n      // Rect is fully on screen, we want to keep it\n      break;\n    }\n    this.hidePost(postMedia);\n  }\n\n  for (i = this.hiddenPosts.length - 1; i > -1; i--) {\n    var hiddenMedia = this.hiddenPosts[i];\n    if (hiddenMedia.absoluteTop < window.scrollY + this.TOP_CUTOFF) {\n      // hiddenMedia is higher than the current viewport\n      // all other posts should also be higher\n      break;\n    }\n    this.showPost(hiddenMedia);\n  }\n};\n\n/**\n * Hide a post, storing it for later\n * @param {DOMElement} post\n */\nLethe.prototype.hidePost = function(post) {\n  console.log('Hiding a post');\n  var rect = post.getBoundingClientRect();\n  var placeholder = document.createElement('div');\n  placeholder.classList.add('post_media_hidden');\n  placeholder.style.width = rect.width + 'px';\n  placeholder.style.height = rect.height + 'px';\n  post.parentNode.replaceChild(placeholder, post);\n\n  var absoluteTop = rect.top + this.scrollY;\n  if (absoluteTop < this.hiddenPosts[this.hiddenPosts.length - 1].absoluteTop) {\n    throw new Error('Lethe post ordering invariant broken');\n  }\n  this.hiddenPosts.push({\n    absoluteTop: absoluteTop,\n    html: post.innerHTML,\n    parent: post.parentNode\n  });\n};\n\n/**\n * Show a post, removing it from hidden posts\n * @param {DOMElement} hiddenPost\n */\nLethe.prototype.showPost = function(hiddenPost) {\n  console.log('Showing a post');\n  // Overly conservative removal logic\n  this.hiddenPosts = this.hiddenPosts.filter(function(post) {\n    return post !== hiddenPost;\n  });\n  hiddenPost.parent.innerHTML = hiddenPost.html;\n};\n\n\n\n/**\n * Destroy Lethe\n */\nLethe.prototype.destroy = function() {\n  if (!this.running) {\n    return;\n  }\n  this.running = false;\n  window.removeEventListener('scroll', this.handleScroll, false);\n};\n","title":"Lethe","description":"Forgets posts once they scroll off the screen.","developer":"hobinjk","version":"1.0 REV A","frame":"false","beta":"false","file":"found","server":"up","errors":false,"slow":"false"}